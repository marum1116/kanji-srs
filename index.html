<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¿˜å´æ›²ç·šã£ã½ã„æ¼¢å­—å¾©ç¿’ï¼ˆSRSï¼‰</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; }
    body { margin: 0; background:#f6f7f9; color:#111; }
    header { padding: 16px; background:#fff; border-bottom:1px solid #e6e8ee; position: sticky; top:0; z-index: 10; }
    h1 { font-size: 18px; margin: 0 0 6px; }
    .sub { font-size: 12px; color:#555; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; font-size: 12px; border: 1px solid #e6e8ee; background:#fafbff; color:#334; }
    .dot { width:8px; height:8px; border-radius:50%; background:#bbb; display:inline-block; }
    .dot.ok { background:#16a34a; }
    .dot.warn { background:#f59e0b; }
    .dot.bad { background:#ef4444; }

    main { padding: 12px; max-width: 900px; margin: 0 auto; }
    section { background:#fff; border:1px solid #e6e8ee; border-radius: 12px; padding: 12px; margin: 12px 0; }
    h2 { font-size: 16px; margin: 0 0 10px; }

    .row { display:flex; gap:8px; flex-wrap: wrap; align-items:flex-start; }
    textarea, input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border:1px solid #ccd2df;
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
      background:#fff;
      color:#111;
    }
    textarea { min-height: 120px; resize: vertical; }

    button { border:0; border-radius: 10px; padding: 10px 12px; font-size: 14px; cursor: pointer; }
    .btn { background:#2f6fed; color:#fff; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .ghost { background:#eef2ff; color:#1f3fb3; }
    .danger { background:#ffecec; color:#a01414; }
    .okbtn { background:#16a34a; color:#fff; }
    .ngbtn { background:#ef4444; color:#fff; }
    .small { font-size: 12px; color:#555; }
    .muted { color:#666; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background:#f0f3ff; color:#2a4bc7; }

    .cards { display:grid; gap:10px; }
    .card { border:1px solid #e6e8ee; border-radius: 12px; padding: 12px; }
    .cardTop { display:flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
    .k { font-size: 44px; line-height: 1; letter-spacing: 2px; }
    .kHidden {
      font-size: 14px;
      padding: 12px 12px;
      border: 2px dashed #ccd2df;
      border-radius: 12px;
      color:#334;
      background:#fafbff;
      white-space: pre-line;
      user-select: none;
    }
    .actions { display:flex; gap:8px; margin-top: 10px; flex-wrap: wrap; }

    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px; border-bottom: 1px solid #eef0f5; text-align: left; vertical-align: top; }
    .right { text-align:right; }

    /* Editor modal */
    .backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 12px;
      z-index: 1000;
    }
    .modal {
      width: min(760px, 100%);
      background: #fff;
      border-radius: 14px;
      border: 1px solid #e6e8ee;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      overflow: hidden;
    }
    .modalHeader {
      padding: 12px 14px;
      border-bottom: 1px solid #eef0f5;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .modalTitle { font-size: 16px; margin:0; }
    .modalBody { padding: 12px 14px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 640px) {
      .grid2 { grid-template-columns: 1fr; }
    }
    .label { font-size: 12px; color:#555; margin: 8px 0 6px; }
    .exRow { display:flex; gap:8px; align-items:center; margin: 8px 0; }
    .exRow input { flex: 1; }
    .iconBtn { padding: 8px 10px; border-radius: 10px; }

    .warnBox {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff7ed;
      border: 1px solid #fed7aa;
      color: #7c2d12;
      font-size: 12px;
      white-space: pre-line;
    }
    .infoBox {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #ecfeff;
      border: 1px solid #a5f3fc;
      color: #155e75;
      font-size: 12px;
      white-space: pre-line;
    }
  </style>
</head>

<body>
<header>
  <h1>å¿˜å´æ›²ç·šã£ã½ã„æ¼¢å­—å¾©ç¿’ï¼ˆSRSï¼‰</h1>
  <div class="sub">
    <span class="pill"><span class="dot ok"></span>ä¾‹æ–‡ã¯ã€Œã²ã‚‰ãŒãªã€ã‚’æ‰‹å‹•å…¥åŠ›ï¼ˆéŸ³å£°å…¥åŠ›ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ğŸ¤ã§ï¼‰</span>
    <span class="pill"><span class="dot ok"></span>æ–¹å¼Bï¼šå¤±æ•—ã§stage-1ï¼ˆä¸‹é™0ï¼‰</span>
    <span class="pill"><span class="dot warn"></span>ä¾‹æ–‡å…¥åŠ›ã¯å¾Œã‹ã‚‰ã§OKï¼ˆç©ºæ¬„OKãƒ»æœ€å¤§5ï¼‰</span>
  </div>
</header>

<main>
  <section>
    <h2>â‘  æ–°è¦ã®æ¼¢å­—ã‚’è¿½åŠ ï¼ˆã¾ã¨ã‚ã¦OKãƒ»ä¾‹æ–‡ã¯ä¸è¦ï¼‰</h2>

    <div class="row">
      <textarea id="addInput" placeholder="æ¼¢å­—ã‚’å…¥åŠ›ï¼ˆ1è¡Œã«1æ–‡å­—ãŒæ¨å¥¨ï¼ç©ºç™½ã‚„æ”¹è¡Œã§åŒºåˆ‡ã£ã¦è¤‡æ•°OKï¼‰
ä¾‹ï¼š
å¼·
å”
èˆˆ
é¡"></textarea>
    </div>

    <div class="row" style="margin-top:8px;">
      <button class="btn" id="addBtn">æ¼¢å­—ã‚’è¿½åŠ </button>
      <button class="ghost" id="exportBtn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button class="ghost" id="importBtn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button class="danger" id="resetBtn">å…¨å‰Šé™¤</button>
    </div>

    <div class="small" style="margin-top:8px;">
      ãƒ»è¿½åŠ æ™‚ã¯ <b>æ¼¢å­—ã ã‘</b> ã§OKï¼ˆèª­ã¿ã¯APIã§è‡ªå‹•å–å¾—ï¼ä¾‹æ–‡ã¯å¾Œã§å…¥åŠ›ï¼‰<br/>
      ãƒ»è¿½åŠ ã—ãŸæ¼¢å­—ã¯ã€Œä»Šæ—¥ã‚„ã‚‹æ¼¢å­—ã€ã«å‡ºãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€å¿…è¦ãªã‚‰ä¾‹æ–‡ã‚’å…¥ã‚Œã¦ãã ã•ã„ï¼ˆä¾‹æ–‡ãªã—ã§ã‚‚å­¦ç¿’ã§ãã¾ã™ï¼‰
    </div>
  </section>

  <section>
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <h2 style="margin:0;">â‘¡ ä»Šæ—¥ã‚„ã‚‹æ¼¢å­— <span class="badge" id="dueCount">0</span></h2>
      <div class="small muted" id="todayRange"></div>
    </div>

    <div class="cards" id="dueList" style="margin-top:10px;"></div>
    <div class="small muted" id="emptyDue" style="display:none; margin-top:8px;">
      ä»Šæ—¥ã®å¾©ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ã®æ¼¢å­—ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ä»Šæ—¥ã®åˆ†ãŒå‡ºã¾ã™ã€‚
    </div>
  </section>

  <section>
    <h2>å…¨æ¼¢å­—ï¼ˆç®¡ç†ï¼‰</h2>
    <div class="small muted" style="margin-bottom:8px;">nextReviewAtï¼ˆæ¬¡å›å¾©ç¿’æ—¥æ™‚ï¼‰ã§ä¸¦ã¹ã¦ã„ã¾ã™ã€‚</div>
    <div style="overflow:auto;">
      <table>
        <thead>
        <tr>
          <th>æ¼¢å­—</th>
          <th>èª­ã¿ï¼ˆéŸ³ï¼è¨“ï¼‰</th>
          <th class="right"></th>
        </tr>
        </thead>
        <tbody id="allTable"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Editor Modal -->
<div class="backdrop" id="backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHeader">
      <h3 class="modalTitle" id="modalTitle">ä¾‹æ–‡ç·¨é›†</h3>
      <div class="row" style="margin:0;">
        <button class="ghost iconBtn" id="closeModalBtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="grid2">
        <div>
          <div class="label">æ¼¢å­—</div>
          <div style="font-size:44px; line-height:1;" id="editKanji">â€”</div>
        </div>
        <div>
          <div class="label">èª­ã¿ï¼ˆAPIè‡ªå‹•å–å¾—ï¼‰</div>
          <div class="small" style="white-space:pre-line;" id="editReading">â€”</div>
        </div>
      </div>

      <div class="label" style="margin-top:12px;">ä¾‹æ–‡ï¼ˆã²ã‚‰ãŒãªæ¨å¥¨ãƒ»ç©ºæ¬„OK / æœ€å¤§5ï¼‰</div>
      <div class="small muted">
        ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§2æ ã‚’å‡ºã—ã¾ã™ï¼ˆç©ºæ¬„ã§ã‚‚OKï¼‰<br/>
        ãƒ»å¾Œã‹ã‚‰ã„ã¤ã§ã‚‚è¿½åŠ ã§ãã¾ã™ï¼ˆæœ¬äººãŒä¾‹æ–‡ã‚’æ€ã„ã¤ã„ãŸæ™‚ã«ã‚‚è¿½è¨˜OKï¼‰
      </div>

      <div id="examplesArea" style="margin-top:6px;"></div>

      <div class="row" style="margin-top:10px;">
        <button class="ghost" id="addExampleBtn">ï¼‹ ä¾‹æ–‡</button>
        <button class="btn" id="saveEditBtn">ä¿å­˜</button>
        <button class="danger" id="deleteKanjiBtn">ã“ã®æ¼¢å­—ã‚’å‰Šé™¤</button>
      </div>

      <div class="warnBox" id="editWarn" style="display:none;"></div>
      <div class="infoBox" id="editInfo" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
  // ===== è¨­å®šï¼ˆå¿˜å´æ›²ç·šã£ã½ã„å¾©ç¿’é–“éš”ï¼‰ =====
  const INTERVALS_MS = [
    6 * 60 * 60 * 1000,
    1 * 24 * 60 * 60 * 1000,
    3 * 24 * 60 * 60 * 1000,
    7 * 24 * 60 * 60 * 1000,
    14 * 24 * 60 * 60 * 1000,
    30 * 24 * 60 * 60 * 1000,
    60 * 24 * 60 * 60 * 1000,
    120 * 24 * 60 * 60 * 1000,
  ];
  const MAX_STAGE = INTERVALS_MS.length - 1;

  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ããŸã„å ´åˆï¼šå‰ã®ã‚­ãƒ¼ï¼ˆä¾‹: kanji_srs_v5 ãªã©ï¼‰ã«åˆã‚ã›ã¦ãã ã•ã„
  const STORAGE_KEY = "kanji_srs_v5";

  async function fetchReadings(kanjiChar) {
    const url = `https://kanjiapi.dev/v1/kanji/${encodeURIComponent(kanjiChar)}`;
    try {
      const res = await fetch(url, { cache: "force-cache" });
      if (!res.ok) throw new Error("bad status");
      const data = await res.json();
      const on = Array.isArray(data.on_readings) ? data.on_readings.join("ï¼") : "";
      const kun = Array.isArray(data.kun_readings) ? data.kun_readings.join("ï¼") : "";
      return { onYomi: on, kunYomi: kun };
    } catch (e) {
      console.warn("Reading fetch failed:", kanjiChar, e);
      return { onYomi: "", kunYomi: "" };
    }
  }

  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    try {
      const data = JSON.parse(raw);
      return Array.isArray(data) ? data : [];
    } catch {
      return [];
    }
  }
  function saveData(items) { localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
  function nowMs() { return Date.now(); }
  function toISO(ms) { return new Date(ms).toISOString(); }

  function fmt(msOrIso) {
    const d = (typeof msOrIso === "string") ? new Date(msOrIso) : new Date(msOrIso);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}/${m}/${day} ${hh}:${mm}`;
  }
  function endOfTodayMs() {
    const d = new Date();
    d.setHours(23, 59, 59, 999);
    return d.getTime();
  }

  function isSingleKanjiChar(s) {
    const chars = Array.from((s ?? "").trim());
    if (chars.length !== 1) return false;
    const code = chars[0].codePointAt(0);
    return (
      (code >= 0x4E00 && code <= 0x9FFF) ||
      (code >= 0x3400 && code <= 0x4DBF) ||
      (code >= 0xF900 && code <= 0xFAFF)
    );
  }

  function containsKanji(s) {
    for (const ch of Array.from((s ?? "").toString())) {
      const code = ch.codePointAt(0);
      const isKanji =
        (code >= 0x4E00 && code <= 0x9FFF) ||
        (code >= 0x3400 && code <= 0x4DBF) ||
        (code >= 0xF900 && code <= 0xFAFF);
      if (isKanji) return true;
    }
    return false;
  }

  function clampExamples(examples) {
    const arr = Array.isArray(examples) ? examples.map(x => (x ?? "").toString()) : [];
    while (arr.length < 2) arr.push("");
    return arr.slice(0, 5);
  }

  function getDueItems(items) {
    const cutoff = endOfTodayMs();
    return items
      .filter(it => new Date(it.nextReviewAt).getTime() <= cutoff)
      .sort((a, b) => new Date(a.nextReviewAt) - new Date(b.nextReviewAt));
  }

  function parseKanjiList(rawText) {
    const tokens = (rawText ?? "")
      .replace(/\s+/g, " ")
      .trim()
      .split(" ")
      .flatMap(t => t.split("\n"))
      .map(s => s.trim())
      .filter(Boolean);

    const out = [];
    for (const t of tokens) {
      for (const ch of Array.from(t)) {
        if (isSingleKanjiChar(ch)) out.push(ch);
      }
    }
    return Array.from(new Set(out));
  }

  async function addKanjiOnly(text) {
    const items = loadData();
    const existing = new Set(items.map(it => it.kanji));

    const list = parseKanjiList(text);
    if (list.length === 0) return { added: 0, ignored: 0, invalid: 1, readingFail: 0 };

    let added = 0, ignored = 0, readingFail = 0;
    const baseNow = nowMs();

    for (const k of list) {
      if (existing.has(k)) { ignored++; continue; }

      const readings = await fetchReadings(k);
      if (!readings.onYomi && !readings.kunYomi) readingFail++;

      const item = {
        kanji: k,
        onYomi: readings.onYomi,
        kunYomi: readings.kunYomi,
        examples: [],
        createdAt: toISO(baseNow),
        stage: 0,
        nextReviewAt: toISO(baseNow + INTERVALS_MS[0]),
        stats: { success: 0, fail: 0, lastResult: null, lastReviewedAt: null }
      };

      items.push(item);
      existing.add(k);
      added++;
    }

    saveData(items);
    return { added, ignored, invalid: 0, readingFail };
  }

  function markResult(kanji, result) {
    const items = loadData();
    const idx = items.findIndex(it => it.kanji === kanji);
    if (idx < 0) return;

    const it = items[idx];
    const now = nowMs();

    if (result === "success") {
      it.stage = Math.min(it.stage + 1, MAX_STAGE);
      it.stats.success += 1;
      it.stats.lastResult = "success";
    } else {
      it.stage = Math.max(it.stage - 1, 0);
      it.stats.fail += 1;
      it.stats.lastResult = "fail";
    }
    it.stats.lastReviewedAt = toISO(now);
    it.nextReviewAt = toISO(now + INTERVALS_MS[it.stage]);

    items[idx] = it;
    saveData(items);
  }

  function removeKanji(kanji) {
    const items = loadData().filter(it => it.kanji !== kanji);
    saveData(items);
  }

  function exportData() {
    const data = localStorage.getItem(STORAGE_KEY) || "[]";
    if (navigator.clipboard?.writeText) {
      navigator.clipboard.writeText(data).then(() => {
        alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼æ¸ˆã¿ï¼‰");
      }).catch(() => {
        prompt("ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„", data);
      });
    } else {
      prompt("ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„", data);
    }
  }

  function importData() {
    const raw = prompt("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONé…åˆ—ï¼‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„");
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) throw new Error("not array");

      const cleaned = parsed
        .filter(x => x && typeof x.kanji === "string")
        .map(x => ({
          kanji: x.kanji,
          onYomi: typeof x.onYomi === "string" ? x.onYomi : "",
          kunYomi: typeof x.kunYomi === "string" ? x.kunYomi : "",
          examples: Array.isArray(x.examples) ? x.examples : [],
          createdAt: x.createdAt || toISO(nowMs()),
          stage: Number.isFinite(x.stage) ? Math.max(0, Math.min(MAX_STAGE, x.stage)) : 0,
          nextReviewAt: x.nextReviewAt || toISO(nowMs() + INTERVALS_MS[0]),
          stats: x.stats && typeof x.stats === "object" ? {
            success: Number.isFinite(x.stats.success) ? x.stats.success : 0,
            fail: Number.isFinite(x.stats.fail) ? x.stats.fail : 0,
            lastResult: (x.stats.lastResult === "success" || x.stats.lastResult === "fail") ? x.stats.lastResult : null,
            lastReviewedAt: x.stats.lastReviewedAt || null
          } : { success: 0, fail: 0, lastResult: null, lastReviewedAt: null }
        }));

      const map = new Map();
      for (const it of cleaned) map.set(it.kanji, it);
      saveData(Array.from(map.values()));
      render();
      alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
    } catch (e) {
      console.error(e);
      alert("å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆJSONé…åˆ—ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼‰");
    }
  }

  // ===== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« =====
  const backdrop = document.getElementById("backdrop");
  const saveEditBtn = document.getElementById("saveEditBtn");
  const addExampleBtn = document.getElementById("addExampleBtn");
  const deleteKanjiBtn = document.getElementById("deleteKanjiBtn");
  const editKanjiEl = document.getElementById("editKanji");
  const editReadingEl = document.getElementById("editReading");
  const examplesArea = document.getElementById("examplesArea");
  const editWarn = document.getElementById("editWarn");
  const editInfo = document.getElementById("editInfo");

  let editingKanji = null;

  function openEditor(kanji) {
    const items = loadData();
    const it = items.find(x => x.kanji === kanji);
    if (!it) return;

    editingKanji = kanji;
    editKanjiEl.textContent = it.kanji;

    const on = it.onYomi ? `éŸ³ï¼š${it.onYomi}` : "éŸ³ï¼šâ€”";
    const kun = it.kunYomi ? `è¨“ï¼š${it.kunYomi}` : "è¨“ï¼šâ€”";
    editReadingEl.textContent = `${on}\n${kun}`;

    renderExamplesInputs(it.examples);

    editWarn.style.display = "none";
    editWarn.textContent = "";
    editInfo.style.display = "none";
    editInfo.textContent = "";

    backdrop.style.display = "flex";
    backdrop.setAttribute("aria-hidden", "false");

    updateKanjiMixedWarning();
  }

  function closeEditor() {
    editingKanji = null;
    backdrop.style.display = "none";
    backdrop.setAttribute("aria-hidden", "true");
  }

  function renderExamplesInputs(examples) {
    const ex = clampExamples(examples);
    examplesArea.innerHTML = "";

    ex.forEach((val, i) => {
      const row = document.createElement("div");
      row.className = "exRow";

      const input = document.createElement("input");
      input.type = "text";
      input.value = val;
      input.placeholder = `ä¾‹æ–‡${i + 1}ï¼ˆã²ã‚‰ãŒãªæ¨å¥¨ï¼ç©ºæ¬„OKï¼‰`;
      input.addEventListener("input", updateKanjiMixedWarning);

      const del = document.createElement("button");
      del.className = "danger iconBtn";
      del.textContent = "å‰Šé™¤";
      del.disabled = ex.length <= 2;
      del.addEventListener("click", () => {
        const current = getExamplesInputs();
        if (current.length <= 2) return;
        current.splice(i, 1);
        renderExamplesInputs(current);
        updateKanjiMixedWarning();
      });

      row.appendChild(input);
      row.appendChild(del);
      examplesArea.appendChild(row);
    });

    addExampleBtn.disabled = ex.length >= 5;
  }

  function getExamplesInputs() {
    const inputs = Array.from(examplesArea.querySelectorAll("input"));
    return inputs.map(inp => inp.value ?? "");
  }

  function updateKanjiMixedWarning() {
    const ex = getExamplesInputs().map(s => (s ?? "").toString().trim()).filter(Boolean);
    const mixed = ex
      .map((line, idx) => ({ idx, line }))
      .filter(x => containsKanji(x.line));

    if (mixed.length === 0) {
      editWarn.style.display = "none";
      editWarn.textContent = "";
      return;
    }

    const lines = mixed.slice(0, 8).map(x => `ãƒ»ä¾‹æ–‡${x.idx + 1}ï¼š${x.line}`);

    editWarn.style.display = "block";
    editWarn.textContent =
      "ä¾‹æ–‡ã«æ¼¢å­—ãŒæ··ã–ã£ã¦ã„ã¾ã™ï¼ˆã²ã‚‰ãŒãªæ¨å¥¨ï¼‰ã€‚\n" +
      lines.join("\n") +
      "\n\nâ†’ æ‰‹å‹•ã§ã²ã‚‰ãŒãªã«ç›´ã—ã¦ãã ã•ã„ï¼ˆã“ã®ç‰ˆã¯è‡ªå‹•å¤‰æ›ã—ã¾ã›ã‚“ï¼‰ã€‚";
  }

  function saveEditor() {
    if (!editingKanji) return;
    const items = loadData();
    const idx = items.findIndex(x => x.kanji === editingKanji);
    if (idx < 0) return;

    const it = items[idx];

    const raw = getExamplesInputs().slice(0, 5).map(s => (s ?? "").toString());
    while (raw.length && !raw[raw.length - 1].trim()) raw.pop();
    it.examples = raw;

    items[idx] = it;
    saveData(items);

    editInfo.style.display = "block";
    const mixed = it.examples.filter(x => containsKanji((x ?? "").toString().trim()));
    editInfo.textContent = mixed.length
      ? "ä¿å­˜ã—ã¾ã—ãŸã€‚\nâ€» ä¾‹æ–‡ã«æ¼¢å­—ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚å¿…è¦ãªã‚‰æ‰‹å‹•ã§ã²ã‚‰ãŒãªã«ç›´ã—ã¦ãã ã•ã„ã€‚"
      : "ä¿å­˜ã—ã¾ã—ãŸã€‚";

    if (mixed.length === 0) closeEditor();
    render();
  }

  // ===== UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
  function render() {
    const items = loadData();

    const start = new Date(); start.setHours(0,0,0,0);
    const end = new Date(); end.setHours(23,59,59,999);
    document.getElementById("todayRange").textContent = `åˆ¤å®šç¯„å›²ï¼š${fmt(start)} ã€œ ${fmt(end)}`;

    const due = getDueItems(items);
    document.getElementById("dueCount").textContent = String(due.length);

    const dueList = document.getElementById("dueList");
    dueList.innerHTML = "";
    document.getElementById("emptyDue").style.display = due.length ? "none" : "block";

    for (const it of due) {
      const card = document.createElement("div");
      card.className = "card";

      const top = document.createElement("div");
      top.className = "cardTop";

      const left = document.createElement("div");

      const hidden = document.createElement("div");
      hidden.className = "kHidden";

      const shown = document.createElement("div");
      shown.className = "k";
      shown.textContent = it.kanji;
      shown.style.display = "none";

      let isRevealed = false;
      function toggleReveal() {
        isRevealed = !isRevealed;
        hidden.style.display = isRevealed ? "none" : "block";
        shown.style.display = isRevealed ? "block" : "none";
      }
      hidden.addEventListener("click", toggleReveal);
      shown.addEventListener("click", toggleReveal);

      // --- è¡¨ç¤ºã‚’ã‚¹ãƒƒã‚­ãƒªï¼šæŒ‡ç¤ºæ–‡ï¼ˆç™½ç´™ã§æ›¸ã„ãŸï¼Ÿï¼ã‚¿ãƒƒãƒ—ã§ç­”ãˆï¼‰ã¯å‰Šé™¤ ---
      const hintLines = [];

      const on = it.onYomi ? `éŸ³ï¼š${it.onYomi}` : "";
      const kun = it.kunYomi ? `è¨“ï¼š${it.kunYomi}` : "";
      const readingLine = [on, kun].filter(Boolean).join(" / ");
      if (readingLine) hintLines.push(readingLine);

      const ex = Array.isArray(it.examples) ? it.examples.map(x => (x ?? "").toString().trim()).filter(Boolean) : [];
      if (ex.length) {
        hintLines.push("ä¾‹æ–‡ï¼š");
        for (const line of ex.slice(0, 5)) hintLines.push(`ãƒ»${line}`);
      } else {
        hintLines.push("ä¾‹æ–‡ï¼šâ€”ï¼ˆå¿…è¦ãªã‚‰ã€Œä¾‹æ–‡ã‚’ç·¨é›†ã€ã§è¿½åŠ ï¼‰");
      }

      hidden.textContent = hintLines.join("\n");

      left.appendChild(hidden);
      left.appendChild(shown);

      top.appendChild(left);

      const actions = document.createElement("div");
      actions.className = "actions";

      const revealBtn = document.createElement("button");
      revealBtn.className = "ghost";
      revealBtn.textContent = "ç­”ãˆï¼ˆæ¼¢å­—ï¼‰";
      revealBtn.addEventListener("click", toggleReveal);

      const editBtn = document.createElement("button");
      editBtn.className = "ghost";
      editBtn.textContent = "ä¾‹æ–‡ã‚’ç·¨é›†";
      editBtn.addEventListener("click", () => openEditor(it.kanji));

      const okBtn = document.createElement("button");
      okBtn.className = "okbtn";
      okBtn.textContent = "æ›¸ã‘ãŸ";
      okBtn.addEventListener("click", () => { markResult(it.kanji, "success"); render(); });

      const ngBtn = document.createElement("button");
      ngBtn.className = "ngbtn";
      ngBtn.textContent = "æ›¸ã‘ãªã‹ã£ãŸ";
      ngBtn.addEventListener("click", () => { markResult(it.kanji, "fail"); render(); });

      actions.appendChild(revealBtn);
      actions.appendChild(editBtn);
      actions.appendChild(okBtn);
      actions.appendChild(ngBtn);

      card.appendChild(top);
      card.appendChild(actions);
      dueList.appendChild(card);
    }

    // å…¨æ¼¢å­—ãƒ†ãƒ¼ãƒ–ãƒ«ï¼šstage/æœŸé™/æˆåŠŸå¤±æ•—ã¯éè¡¨ç¤º
    const tbody = document.getElementById("allTable");
    tbody.innerHTML = "";

    const sorted = [...items].sort((a,b) => new Date(a.nextReviewAt) - new Date(b.nextReviewAt));
    for (const it of sorted) {
      const tr = document.createElement("tr");
      const on = it.onYomi ? it.onYomi : "â€”";
      const kun = it.kunYomi ? it.kunYomi : "â€”";
      tr.innerHTML = `
        <td style="font-size:20px;">${it.kanji}</td>
        <td><div class="small">éŸ³ï¼š${on}</div><div class="small">è¨“ï¼š${kun}</div></td>
        <td class="right">
          <button class="ghost" data-edit="${it.kanji}" style="padding:6px 10px; border-radius:10px;">ä¾‹æ–‡</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const k = e.currentTarget.getAttribute("data-edit");
        if (!k) return;
        openEditor(k);
      });
    });
  }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
  document.getElementById("addBtn").addEventListener("click", async () => {
    const addBtn = document.getElementById("addBtn");
    const addInput = document.getElementById("addInput");

    const text = addInput.value || "";
    addBtn.disabled = true;
    addBtn.textContent = "è¿½åŠ ä¸­â€¦";

    const res = await addKanjiOnly(text);

    addBtn.disabled = false;
    addBtn.textContent = "æ¼¢å­—ã‚’è¿½åŠ ";

    addInput.value = "";
    render();

    if (res.invalid) {
      alert("è¿½åŠ ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¼¢å­—ï¼ˆ1æ–‡å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    let msg = `è¿½åŠ : ${res.added} / æ—¢ã«ç™»éŒ²: ${res.ignored}`;
    if (res.readingFail) msg += `\næ³¨æ„: èª­ã¿ã‚’å–å¾—ã§ããªã‹ã£ãŸæ¼¢å­—ãŒ ${res.readingFail} ä»¶ã‚ã‚Šã¾ã™ï¼ˆèª­ã¿ã¯ç©ºæ¬„ã§ã™ï¼‰ã€‚`;
    alert(msg);
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    if (confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
      localStorage.removeItem(STORAGE_KEY);
      render();
    }
  });

  document.getElementById("exportBtn").addEventListener("click", exportData);
  document.getElementById("importBtn").addEventListener("click", importData);

  // ãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById("closeModalBtn").addEventListener("click", closeEditor);
  document.getElementById("backdrop").addEventListener("click", (e) => { if (e.target === e.currentTarget) closeEditor(); });

  document.getElementById("addExampleBtn").addEventListener("click", () => {
    if (!editingKanji) return;
    const current = clampExamples(getExamplesInputs());
    if (current.length >= 5) return;
    current.push("");
    renderExamplesInputs(current);
    updateKanjiMixedWarning();
  });

  saveEditBtn.addEventListener("click", saveEditor);

  deleteKanjiBtn.addEventListener("click", () => {
    if (!editingKanji) return;
    const k = editingKanji;
    if (confirm(`ã€Œ${k}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
      removeKanji(k);
      closeEditor();
      render();
    }
  });

  // åˆæœŸè¡¨ç¤º
  render();
</script>
</body>
</html>
